<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome Guide</title>
  <style>
    :root { --bg:#0b0e14; --card:rgba(255,255,255,.12); --glass:rgba(255,255,255,.08); --txt:#fff; --muted:#dfe3ea; }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--txt); background: var(--bg); }
    .wrap { min-height: 100dvh; display:grid; place-items:center; padding: 32px 16px; background: center/cover no-repeat var(--bg); }
    .card { width:min(880px, 96vw); backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.55)); border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,.4); overflow:hidden }
    .hero { padding: 28px 24px 8px 24px; text-align:center }
    .badge { display:inline-grid; place-items:center; width:68px; height:68px; border-radius: 18px; background: var(--glass); margin: 0 auto 16px auto; font-weight:700; }
    h1 { margin: 0 0 6px 0; font-size: clamp(28px,5vw,44px); line-height:1.1 }
    .hosted { opacity:.9; margin: 0 0 16px 0 }
    .stack { display:grid; gap:12px; padding: 16px 24px 26px 24px }
    .pill { display:flex; align-items:center; gap:10px; background: var(--card); border-radius: 12px; padding: 12px 14px; }
    .pill a, .pill span { color: var(--muted); text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100% }
    .cta { display:grid; place-items:center; padding: 20px 24px 28px 24px }
    .round { width:84px; height:84px; border-radius:50%; background: var(--glass); display:grid; place-items:center; font-weight:800; border:2px solid rgba(255,255,255,.15) }
    .footer { text-align:center; font-size:12px; opacity:.7; padding-bottom: 18px }
    .hidden { display:none !important }
  </style>
</head>
<body>
  <!-- Background image is set by data-bind="visual.cover" + data-format="bg" -->
  <div class="wrap" id="bg" data-bind="visual.cover" data-format="bg">
    <div class="card">
      <div class="hero">
        <div class="badge">üè°</div>
        <h1 id="title" data-bind="property.name">Your Property</h1>
        <p class="hosted">Hosted by <span data-bind="host.name">Your Name</span></p>
      </div>

      <div class="stack">
        <div class="pill">
          <span>üìû</span>
          <a data-bind="contact.phone" data-attr="href" data-format="tel" id="phoneLink">+1 234 567 8901</a>
        </div>
        <div class="pill">
          <span>‚úâÔ∏è</span>
          <a data-bind="contact.email" data-attr="href" data-format="mailto" id="emailLink">host@example.com</a>
        </div>
        <div class="pill">
          <span>üìç</span>
          <span id="address" data-bind="property.address">123 Lakeview Dr</span>
        </div>
        <div class="pill">
          <span>üåÜ</span>
          <span id="cityCountry"><span data-bind="property.city">City</span>, <span data-bind="property.country">Country</span></span>
        </div>
        <!-- Add more pills as you need; just add data-bind paths -->
      </div>

      <div class="cta">
        <div class="round">CLICK</div>
      </div>

      <div class="footer">
        <span id="updatedAt" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const GUIDE_ID = qs.get('id') || 'jv';
      const FN_BASE = '/.netlify/functions';

      const $ = (s, root=document) => root.querySelector(s);
      const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

      // Helpers
      const get = (obj, path) => path.split('.').reduce((o,k)=> (o && o[k] !== undefined ? o[k] : undefined), obj);
      function format(val, el) {
        const fmt = el.dataset.format;
        if (!fmt) return val ?? '';
        if (fmt === 'tel') return 'tel:' + String(val || '').replace(/\s+/g, '');
        if (fmt === 'mailto') return 'mailto:' + (val || '');
        if (fmt === 'bg') return `background-image:url('${val}')`;
        return val ?? '';
      }

      function bindAll(data) {
        // Apply data-bind attributes
        $$('[data-bind]').forEach((el) => {
          const raw = get(data, el.dataset.bind);
          const out = format(raw, el);
          const attr = el.dataset.attr;

          if (attr) el.setAttribute(attr, out);
          else if (el.dataset.html != null) el.innerHTML = out ?? '';
          else el.textContent = (out ?? '');

          // If bg set on wrapper, ensure CSS uses it
          if (el.dataset.format === 'bg' && el.id === 'bg') {
            el.style.backgroundImage = out.replace('background-image:','');
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
          }
        });

        // Nice ‚Äúlast updated‚Äù
        if (data.updated_at) {
          const t = new Date(data.updated_at);
          $('#updatedAt').textContent = 'Updated: ' + t.toLocaleString();
        }
      }

      async function load() {
        try {
          const res = await fetch(`${FN_BASE}/load?id=${encodeURIComponent(GUIDE_ID)}`, { cache: 'no-store' });
          // If no record yet, res may be 200 with {}, or 404 from our function variant
          if (!res.ok) throw new Error('Load failed: ' + res.status);
          const payload = await res.json();
          const data = payload.data || payload || {};

          // Minimal defaults if fields are missing
          const merged = {
            host: { name: 'Your Host', ...(data.host || {}) },
            property: {
              name: 'Your Property',
              address: 'Address will appear here',
              city: 'City',
              country: 'Country',
              ...(data.property || {})
            },
            contact: { phone: '', email: '', ...(data.contact || {}) },
            visual: { cover: (data.visual && data.visual.cover) || '' },
            updated_at: payload.updated_at || data.updated_at
          };

          bindAll(merged);
        } catch (err) {
          console.error(err);
          // Fallback: show placeholders
          bindAll({
            host:{name:'Your Host'},
            property:{name:'Your Property',address:'Address will appear here',city:'City',country:'Country'},
            contact:{phone:'',email:''},
            visual:{cover:''}
          });
        }
      }

      load();
    })();
  </script>
</body>
</html>
